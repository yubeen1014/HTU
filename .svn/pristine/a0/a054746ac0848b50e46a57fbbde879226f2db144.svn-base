<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles"%>
<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTU</title>
<link rel="icon" href="/resources/images/favicon.ico">
<link href="/resources/css/reset.css" rel="stylesheet" />
<link href="/resources/css/style.css" rel="stylesheet" />
<link href="/resources/css/bootstrap.min.css" rel="stylesheet">
<script src="/resources/js/jquery.min.js"></script>
<style>
.login_div {
	position: relative;
	width: 300px;
}

.login_input {
	font-size: 15px;
	color: #222222;
	width: 318px;
	border: none;
	padding-left: 10px;
	position: relative;
	background: none;
	z-index: 5;
}

.login_input::placeholder {
	color: #aaaaaa;
}

.login_input:focus {
	outline: none;
}

.login_div span {
	display: block;
	position: absolute;
	bottom: 0;
	left: 0%;
	background-color: #666;
	width: 0;
	height: 2px;
	border-radius: 2px;
	transition: 0.5s;
}

.login_div label {
	position: absolute;
	color: #aaa;
	left: 10px;
	font-size: 18px;
	transition: all .2s;
}

.login_input:focus ~ label, input:valid ~ label {
	font-size: 14px;
	bottom: 33px;
	color: #666;
	font-weight: bold;
}

.login_input:focus ~ span, input:valid ~ span {
	width: 100%;
}

/* Additional Styles for the Modal */
.custom-modal {
	display: none;
	position: fixed;
	z-index: 1;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
	background-color: #fefefe;
	margin: 10% auto;
	padding: 20px;
	border: 1px solid #888;
	width: 80%;
	max-width: 470px;
	border-radius: 5px;
	text-align: center;
}

.close-modal {
	position: absolute;
	top: 10px;
	right: 10px;
	font-size: 20px;
	cursor: pointer;
}
</style>
<!-- sweetalert -->
<link rel="stylesheet" href="/resources/css/sweetalert2.min.css">
</head>
<body>
	<div
		style="background-color: #eeeeee; width: 100%; height: 100vh; margin: 0; padding: 0;"
		class="loginPage">
		<div class="background"
			style="display: flex; flex-direction: column; box-sizing: border-box; padding: 40px; width: 900px; height: 450px; border-radius: 3px; box-shadow: 0px 0px 10px 1px #dedede; background-color: #ffffff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
			<div class="login_logo_box"
				style="margin: 0 auto; display: flex; align-items: center;">
				<img src="/resources/images/login_logo.png" alt="logo"
					style="width: 80px; margin-right: 10px;">
				<p style="font-size: 22px; font-weight: 600;">학사관리시스템</p>
			</div>
			<div style="display: flex;">
				<div
					style="border-radius: 3px 0 0 3px; width: 450px; border-right: 2px solid #d1d0d0; padding: 20px;">
					<div style="display: flex;">
						<div
							style="font-size: 18px; font-weight: 600; margin-bottom: 40px;">로그인</div>
					</div>
					<form action="/login" method="post">
						<div class="login_div"
							style="border: 1px solid #d1d0d0; width: 320px; height: 40px; line-height: 40px; margin-bottom: 30px;">
							<input type="text" class="login_input" name="username"
								required="required" autofocus /> <label>ID</label> <span></span>
						</div>
						<div class="login_div"
							style="border: 1px solid #d1d0d0; width: 320px; height: 40px; line-height: 40px; margin-bottom: 10px;">
							<input type="password" class="login_input" name="password"
								required="required" /> <label>pw</label> <span></span>
						</div>
						<div
							style="display: flex; justify-content: space-between; font-size: 11px; margin: 20px 0;">
							<div style="display: flex;">
								<input type="checkbox" id="remember"
									style="border: 1px solid red;" /> <label for="remember">
									<span
									style="font-size: 11px; font-weight: 400; margin-left: 3px;">학번/사번
										저장<span>
								</label>
							</div>
							<div style="display: flex; margin-right: 47px;">
								<div class="hoverBold" onclick="openIdModal()"
									style="margin-right: 8px; cursor: pointer;">학번/사번 찾기</div>
								<div class="hoverBold" onclick="openPwModal()"
									style="cursor: pointer;">비밀번호찾기</div>
							</div>
						</div>
						<button type="submit"
							style="border: none; width: 320px; height: 40px; background-color: #40060b; color: #ffffff; line-height: 40px; text-align: center; cursor: pointer;">로그인</button>
						<sec:csrfInput />
					</form>
				</div>
				<div
					style="font-size: 18px; font-weight: 600; border-radius: 0 3px 3px 0; width: 450px; padding: 20px;">
					<div style="margin-bottom: 20px;">시스템 공지</div>
				</div>
			</div>
		</div>
	</div>

	<!--------------------------------------- 학번/사번 찾기 모달창 시작 --------------------------------------->
	<div class="custom-modal" id="findIdModal">
		<div class="modal-content">
			<span class="close-modal" onclick="closeModal()">&times;</span>
			<h2 style="margin-bottom: 20px; color: #000;">학번/사번 찾기</h2>
			<div style="margin-bottom: 15px; text-align: left;">
				<label for="userName"
					style="display: block; margin-bottom: 5px; font-weight: bold; position: relative; left: 5px;">사용자
					정보</label> <input type="text" id="userNm" name="userNm"
					placeholder="이름을 입력하세요"
					style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
					required>
			</div>
			<div style="margin-bottom: 20px; text-align: left; display: flex;">
				<input type="text" id="userReg1" name="userReg1" pattern="\d{1,6}"
					placeholder="주민번호 앞 6자리"
					style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px 0 0 5px;"
					required
					oninput="this.value = this.value.replace(/\D/g,'').substring(0, 6)">
				<span style="padding: 10px; font-size: 20px;">-</span> <input
					type="text" id="userReg2" name="userReg2" pattern="\d{1,7}"
					placeholder="뒷 7자리"
					style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 0 5px 5px 0;"
					required
					oninput="this.value = this.value.replace(/\D/g,'').substring(0, 7)">
			</div>
			<button type="button" id="btnFind"
				style="width: 100%; background-color: #800000; color: #fff; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">학번/사번
				찾기</button>
		</div>
	</div>
	<!--------------------------------------- 학번/사번 찾기 모달창 끝 --------------------------------------->

	<!--------------------------------------- 사용자 코드 표시 모달창 --------------------------------------->
	<div class="custom-modal" id="userCdModal">
		<div class="modal-content">
			<span class="close-modal" onclick="closeUserCdModal()">&times;</span>
			<h2 style="margin-bottom: 20px; color: #800000;">학번/사번</h2>
			<div id="userCdDisplay"
				style="margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold;"></div>
			<!-- 직접 링크로 이동 -->
			<a href="/login"
				style="background-color: #800000; color: #fff; padding: 10px 20px; text-decoration: none; display: inline-block; border-radius: 5px;">확인</a>
		</div>
	</div>
	<!--------------------------------------- 사용자 코드 표시 모달창 끝 --------------------------------------->

	<!--------------------------------------- 비밀번호 찾기 모달 창 시작 --------------------------------------->
	<div class="custom-modal" id="findPasswordModal">
		<div class="modal-content">
			<span class="close-modal" onclick="closePwModal()">&times;</span>
			<h2 style="margin-bottom: 20px; color: #000;">비밀번호 찾기</h2>
			<div style="margin-bottom: 15px; text-align: left;">
				<label for="userId"
					style="display: block; margin-bottom: 5px; font-weight: bold; position: relative; left: 5px;">학번/사번
				</label> <input type="text" id="userCd" name="userCd" maxlength="8"
					placeholder="학번/사번을 입력하세요"
					style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
					oninput="validateNumericInput(this)" required>
			</div>
			<div style="margin-bottom: 15px; text-align: left;">
				<label for="userPhone"
					style="display: block; margin-bottom: 5px; font-weight: bold; position: relative; left: 5px;">휴대폰
					번호</label> <input type="text" id="userTel" name="userTel" maxlength="11"
					placeholder="-를 제외한 휴대폰 번호를 입력하세요"
					style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
					oninput="validateNumericInput(this)" required>
			</div>
			<button type="button" id="btnFindPassword"
				style="width: 100%; background-color: #800000; color: #fff; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">비밀번호
				찾기</button>
		</div>
	</div>
	<!--------------------------------------- 비밀번호 찾기 모달 창 끝 --------------------------------------->
	<!-- 비밀번호 찾기 모달에서 숫자만 입력하게끔 시작 -->
	<script>
		function validateNumericInput(element) {
			// Allow only numeric input
			element.value = element.value.replace(/\D/g, '').substring(0,
					element.maxLength);
		}
	</script>
	<!-- 비밀번호 찾기 모달에서 숫자만 입력하게끔 끝 -->
	
	<script src="/resources/js/main.js"></script>
   	<!--sweetalert-->
    <script src="/resources/js/sweetalert2.min.js"></script>
	<script src="/resources/js/bootstrap.min.js"></script>
	<c:if test="${not empty error}">
		<script>
			alertError("로그인 정보가 일치하지 않습니다.");
		</script>
	</c:if>
	<script type="text/javascript">
		function openIdModal() {
			$('#findIdModal').show();
		}

		function openPwModal() {
			$('#findPasswordModal').show();
		}

		function closeModal() {
			$('#findIdModal').hide();
		}

		function closePwModal() {
			$('#findPasswordModal').hide();
		}

		function closeUserCdModal() {
			$('#userCdModal').hide();
		}

		function openUserCdModal(userCd) {
			$('#userCdDisplay').text("학번/사번: " + userCd);
			$('#userCdModal').show();
		}

		$(function() {
			$("#btnFind").on(
					"click",
					function() {
						const userNm = $("#userNm").val();
						const userReg1 = $("#userReg1").val();
						const userReg2 = $("#userReg2").val();

						console.log("userNm:", userNm);
						console.log("userReg1:", userReg1);
						console.log("userReg2:", userReg2);

						let data = {
							"userNm" : userNm,
							"userReg1" : userReg1,
							"userReg2" : userReg2
						};

						//{"userNm": "강아지","userReg1": "040101","userReg2": "2222222"}
						console.log("data : ", data);

						// Ajax 요청 전에 CSRF 토큰 가져오기
						// 			const csrfToken = $("meta[name='_csrf']").attr("content");
						// 			const csrfHeader = $("meta[name='_csrf_header']").attr("content");

						$.ajax({
							url : "/findinfo/loginSearchId",
							contentType : "application/json;charset=utf-8",
							data : JSON.stringify(data),
							type : "post",
							dataType : "json",
							beforeSend : function(xhr) {
								xhr.setRequestHeader("${_csrf.headerName}",
										"${_csrf.token}");
							},
							success : function(result) {
								console.log("result : ", result);
								if (result.result && result.result.userCd) {
									openUserCdModal(result.result.userCd);
								} else {
									alert("사용자 정보를 다시 입력해주세요.");
									$("#userNm").val("");
									$("#userReg1").val("");
									$("#userReg2").val("");
								}
							},
							error : function(request, status, error) {
								console.log("status : " + status + ", error : "
										+ error);
								alert("사용자 정보를 다시 입력해주세요.");
								$("#userNm").val("");
								$("#userReg1").val("");
								$("#userReg2").val("");
							}
						});
					});

			$("#btnFindPassword").on(
					"click",
					function() {
						const userCd = $("#userCd").val();
						const userTel = $("#userTel").val();

						console.log("userCd:", userCd);
						console.log("userTel:", userTel);

						let data = {
							"userCd" : userCd,
							"userTel" : userTel,
						};

						console.log("data : ", data);

						$.ajax({
							url : "/findinfo/loginSearchPw",
							contentType : "application/json;charset=utf-8",
							data : JSON.stringify(data),
							type : "post",
							dataType : "json",
							beforeSend : function(xhr) {
								xhr.setRequestHeader("${_csrf.headerName}",
										"${_csrf.token}");
							},
							success : function(result) {
								console.log("result : ", result);
								if (result.result && result.result.userPass) {
									openUserPassModal(result.result.userPass);
								} else {
									alert("사용자 정보를 다시 입력해주세요.");
									$("#userCd").val("");
									$("#userTel").val("");
								}
							},
							error : function(request, status, error) {
								console.log("status : " + status + ", error : "
										+ error);
								alert("사용자 정보를 다시 입력해주세요.");
								$("#userCd").val("");
								$("#userTel").val("");
							}
						});
					});
		});
	</script>
</body>
</html>