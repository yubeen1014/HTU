<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<script src="/resources/js/jquery.min.js"></script>
<style>
.divMailbox .mailHeaderName {
	font-size: 20px;
	padding-bottom: 30px;
}

.dataTables_paginate paging_simple_numbers {
	margin: 0 auto;
}

.col-sm-12 col-md-7 {
	margin: 0 auto;
}

#searchForm {
	position: absolute;
	left: 76%;
	top: 40px;
	display: flex;
	align-items: center;
	background-color: #f5f5f5;
	border-radius: 5px;
	padding: 5px;
}

#searchForm select, #searchForm input {
	height: 30px;
	margin-right: 5px;
	border: 1px solid #dedede;
	border-radius: 3px;
	font-size: 14px;
	padding: 0 5px;
}

#searchForm select {
	color: #333;
}

#searchForm input {
	background-color: #fff;
}

#searchForm button {
	border: none;
	color: #fff;
	cursor: pointer;
	border-radius: 5px;
	padding: 0 10px;
	display: flex;
	align-items: center;
	justify-content: center;
}

#searchForm button i {
	margin-right: 5px;
}

#searchForm label {
	margin-right: 10px;
	font-size: 14px;
	color: #333;
}

.pagination {
	display: flex;
	justify-content: center;
	list-style: none; /* 추가된 부분 */
	padding: 0; /* 추가된 부분 */
}

.pagination li {
	margin: 0 5px;
}

.pagination a {
	text-decoration: none;
	color: #333;
	font-weight: bold;
	padding: 5px 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	cursor: pointer;
}

.page-navigation {
	position: absolute;
	left: -8%;
	bottom: 1%;
	width: 100%;
	text-align: center;
}
</style>
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" href="/resources/test/fonts/icomoon/style.css">

<!-- Style -->
<link rel="stylesheet" href="/resources/test/css/style.css">
</head>
<body>
	<sec:authentication property="principal.userVO" var="userVO" />
	<div class="divMailbox">
		<div class="mailHeader">
			<div class="mailHeaderName">받은 메일함</div>
			<!------- 검색기능 ------->
			<form id="searchForm" action="/mail/inbox" method="get"
				style="position: relative; left: 316%; top: 40px;">
				<select name="type">
					<option value=""
						<c:out value='${pageMaker.cri.type == null? "selected": ""}'/>>선택</option>
					<option value="T"
						<c:out value='${pageMaker.cri.type eq "T"?"selected": "" }'/>>제목</option>
					<option value="C"
						<c:out value='${pageMaker.cri.type eq "C"?"selected": "" }'/>>내용</option>
					<option value="W"
						<c:out value='${pageMaker.cri.type eq "W"?"selected": "" }'/>>작성자</option>
				</select> <input type="text" name="keyword" style="border: 1px solid #ccc;"
					value="<c:out value='${pageMaker.cri.keyword}'/>"> <input
					type="hidden" name="pageNum"
					value="<c:out value='${pageMaker.cri.pageNum}'/>"> <input
					type="hidden" name="amount"
					value="<c:out value='${pageMaker.cri.amount}' />">
				<button class="btn btn-default"
					style="border: 1px solid #000; color: #000; position: absolute; top: 12px; right: -52px;">
					<a style="position: relative; top: 0px;">검색</a>
				</button>
			</form>
			<!------- 검색기능 끝------->
		</div>
		<div class="containerMail">
			<table class="table custom-table">
				<thead>
					<tr>
						<th scope="col" style="width: 2px;"><label
							class="control control--checkbox"> <input type="checkbox"
								class="js-check-all" name="mailCheck" />
								<div class="control__indicator"></div>
						</label></th>
						<th><a type="button" onclick="readCheck()">읽음</a> <a
							type="button" onclick="deleteCheck()">삭제</a></th>
					</tr>
				</thead>
				<tbody>
					<c:forEach var="univMailVO" items="${data}">
						<tr>
							<th scope="row"><label class="control control--checkbox">
									<input type="checkbox" name="mailCheck"
									data-uml-cd="${univMailVO.umlCd}" />
									<div class="control__indicator"></div>
							</label></th>
							<td><c:if test="${univMailVO.umlYn eq 0}">
									<img alt="" class="mailRead" src="/resources/images/mail2.png"
										style="width: 28px; height: 28px;" />
								</c:if> <c:if test="${univMailVO.umlYn eq 1}">
									<img alt="" class="mailRead"
										src="/resources/images/readmail.png"
										style="width: 26px; height: 26px;" />
								</c:if></td>
							<td style="width: 15%;">${univMailVO.userVO.userNm}</td>
							<td style="width: 45%;"><a class="mailTitle"
								href="/mail/receiveDetail?umlCd=${univMailVO.umlCd}">${univMailVO.umlTitle}</a>
							</td>
							<td class="mailTbl-center" style="width: 20%;"><fmt:formatDate
									pattern="MM월 dd일 HH:mm" value="${univMailVO.umlReg}" /></td>
							<td style="width: 10%;"><img src="/resources/images/x.png"
								style="width: 10px; height: 10px;" class="deleteMail"
								data-uml-cd="${univMailVO.umlCd}" /></td>
						</tr>
					</c:forEach>
				</tbody>
			</table>
			<!-- 페이지 시작 -->
			<nav class="page-navigation">
				<ul class="pagination">
					<c:if test="${pageMaker.prev}">
						<li class="paginate_button previous"><a class="page-link"
							href="${pageMaker.startPage - 1}">이전 페이지</a></li>
					</c:if>
					<c:forEach var="num" begin="${pageMaker.startPage }"
						end="${pageMaker.endPage }">
						<li class="paginate_button"><a class="page-link"
							href="${num}">${num}</a></li>
					</c:forEach>
					<c:if test="${pageMaker.next}">
						<li class="paginate_button next"><a class="page-link"
							href="${pageMaker.endPage + 1}">다음 페이지</a></li>
					</c:if>
				</ul>
			</nav>
			<!-- 페이지 끝 -->

			<!-- 페이지 폼 시작 -->
			<form id='actionForm' action="/mail/inbox" method="get">
				<input type="hidden" name="pageNum" value="${pageMaker.cri.pageNum}">
				<input type="hidden" name="amount" value="${pageMaker.cri.amount}">
				<input type="hidden" name="type"
					value="<c:out value='${pageMaker.cri.type}'/>"> <input
					type="hidden" name="keyword"
					value="<c:out value='${pageMaker.cri.keyword}'/>">
			</form>
			<!-- 페이지 폼 끝 -->
		</div>
	</div>
	<script src="/resources/test/js/jquery-3.3.1.min.js"></script>
	<script src="/resources/test/js/popper.min.js"></script>
	<script src="/resources/test/js/bootstrap.min.js"></script>
	<script src="/resources/test/js/main.js"></script>
</body>
<script type="text/javascript">
	$(function() {
		function readCheck() {
			let readArr = [];

			$('input:checkbox[name=mailCheck]').each(function(index) {
				if ($(this).is(":checked") == true) {
					readArr.push($(this).data("umlCd"));
				}
			});

			console.log("readArr:", readArr);

			$.ajax({
				url : "/mail/readCheck",
				contentType : "application/json; charset=utf-8",
				data : JSON.stringify(readArr),
				type : "post",
				beforeSend : function(xhr) {
					xhr.setRequestHeader("${_csrf.headerName}",
							"${_csrf.token}");
				},
				success : function(res) {
					console.log("읽음!");
					location.reload();
				}
			});
		}

		function deleteCheck() {
			let deleteArr = [];

			$('input:checkbox[name=mailCheck]').each(function(index) {
				if ($(this).is(":checked") == true) {
					deleteArr.push($(this).data("umlCd"));
				}
			});

			$.ajax({
				url : "/mail/deleteCheck",
				contentType : "application/json; charset=utf-8",
				data : JSON.stringify(deleteArr),
				type : "post",
				beforeSend : function(xhr) {
					xhr.setRequestHeader("${_csrf.headerName}",
							"${_csrf.token}");
				},
				success : function(res) {
					console.log("삭제!");
					location.reload();
				}
			});
		}

		$(".deleteMail").on(
				"click",
				function() {
					if (confirm("삭제하시겠습니까?")) {
						let umlCd = $(this).data("umlCd");
						console.log("umlCd : " + umlCd);

						$.ajax({
							url : "/mail/deleteReceiveMail?umlCd=" + umlCd,
							data : umlCd,
							type : "post",
							beforeSend : function(xhr) {
								xhr.setRequestHeader("${_csrf.headerName}",
										"${_csrf.token}");
							},
							success : function(res) {
								alert("삭제 완료");
								location.reload();
							}
						});
					}
				});
	});
	let actionForm = $('#actionForm');

	$('.paginate_button a').on('click', function(e) {
		e.preventDefault();
		//걸어둔 링크로 이동하는 것을 일단 막음 
		actionForm.find('input[name="pageNum"]').val($(this).attr('href'));
		actionForm.submit();
	});

	let searchForm = $('#searchForm');
	$('#searchForm button').on('click', function(e) {
		if (!searchForm.find('option:selected').val()) {
			alert('검색종류를 선택하세요');
			return false;
		}
		if (!searchForm.find('input[name="keyword"]').val()) {
			alert('키워드를 입력하세요');
			return false;
		}
		e.preventDefault();
		searchForm.find('input[name="pageNum"]').val('1');
		searchForm.submit();
	});
</script>
</html>