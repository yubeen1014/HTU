<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>

<link rel="stylesheet" href="path/to/fontawesome/css/all.min.css" />

<sec:authentication property="principal.userVO" var="userVO" />
<input type="hidden" name="taskCd" value="${taskVO.taskCd}" id="taskCd" />
<input type="hidden" name="lecCd" value="${taskVO.lecCd}" />


<input type="hidden" id="taskCd" value="${taskVO.taskCd}" />
<input type="hidden" id="stuCd" value="${userVO.userCd}" />

<div style="width:100%; height:100%; padding:30px; background-color:#ffffff;">
	<div style="border-bottom:1px solid #333; padding-bottom:20px; ">
		<!-- 타이틀 -->
		<input name="lecCd" value="${taskVO.taskNm}" style="font-size:28px; font-weight:600;" readonly="readonly"/>
		<!-- 교수명, 제출일  -->
		<div style="font-size:13px; display:flex; align-items:center; margin-top:10px;">
			<!-- 교수명 -->
			<input value="${taskVO.lectureVO.lectureApplyVO.professorVO.userVO.userNm}" style="font-size:15px; width:50px; text-align:left;" readonly="readonly"/>
			<span style="font-size:20px;">&nbsp;ㆍ&nbsp;</span>
			<!-- 제출일 -->
			<fmt:formatDate value="${taskVO.taskReg}" pattern="yyyy-MM-dd"/>
<!-- 			<input value="24.01.05" style="font-size:15px; width:70px;"/> -->
		</div>
		<!-- 점수배점 -->
		<div style="display:flex; font-size:15px; align-items:center;">
			<span style="height:23.6px; line-height:23.6px;">마감일&nbsp;&nbsp;:&nbsp;&nbsp;</span>
			<fmt:formatDate value="${taskVO.taskEddt}" pattern="yyyy-MM-dd"/>
<!-- 			<input value="100" style="font-size:15px; width:40px;"/> -->
		</div>
	</div>
  <div style="display:flex; margin-top:20px; height:72%; justify-content:space-between; border-bottom:1px solid #ccc; padding-bottom:20px; ">
		<!-- 과제내용  -->
		<div style="padding:20px; width:calc(100% - 300px); margin-right:20px;">
		${taskVO.taskCon}
		</div>
		<div class="submitDiv">
		<c:choose>
			<c:when test="${taskSubmitVO.tsubCd eq null}">
				<div style="position:relative; width:300px; height:150px; padding:20px; box-sizing:border-box; border:1px solid #ccc; border-radius:5px; margin-top:20px; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 2px 6px 2px rgba(60,64,67,.15);">
					<div style="display:flex; justify-content:space-between; align-items:end;">	
						<div style="font-size:20px;">과제제출함</div>
						<div style="font-size:15px;">미제출</div>
					</div>
					<input type="file" name="uploadFiles" id="submitFile" multiple="multiple" style="margin-top:20px; width:100%; font-size:14px; border:1px solid #ccc; line-height:23px; height:30px; background-color:#fff;border-radius:3px;"/>
					<button type="button" id="tasksubmitButton" style="border:1px solid #ccc; border-radius:3px; background-color:#ebebeb; font-size:13px; height:30px; margin-top:5px; line-height:30px; position:absolute; right:20px; bottom:20px;">과제제출</button>
				</div>
			</c:when>
			<c:otherwise>
				<div style="position:relative; width:300px; height:150px; padding:20px; box-sizing:border-box; border:1px solid #ccc; border-radius:5px; margin-top:20px; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 2px 6px 2px rgba(60,64,67,.15);">
					<div style="display:flex; justify-content:space-between; align-items:end;">	
						<div style="font-size:20px;">과제제출함</div>
						<div style="font-size:15px;">제출완료</div>
					</div>
					<c:forEach var="vo" items="${taskSubmitVO.filesDetailVOList}" varStatus="">
						<a class="fileLink" href="/resources/upload/${vo.fileSvnm}"  style="margin-top:20px; width:100%; font-size:14px; border:1px solid #ccc; line-height:23px; height:30px; background-color:#fff;border-radius:3px;" download>${vo.fileOrnm}</a>
					</c:forEach>
					<input type="file" name="uploadFiles" id="submitFile" multiple="multiple" style="margin-top:20px; width:100%; font-size:14px; border:1px solid #ccc; line-height:23px; height:30px; background-color:#fff;border-radius:3px;display: none;"/>
					<button type="button" id="tasksubmitUpdateButton" style="border:1px solid #ccc; border-radius:3px; background-color:#ebebeb; font-size:13px; height:30px; margin-top:5px; line-height:30px; position:absolute; right:20px; bottom:20px;">수정</button>
					<button type="button" id="tasksubmitUpdateSubmitButton" style="border:1px solid #ccc; border-radius:3px; background-color:#ebebeb; font-size:13px; height:30px; margin-top:5px; line-height:30px; position:absolute; right:20px; bottom:20px;display: none;">제출</button>
				</div>
			</c:otherwise>
		</c:choose>
		</div>
  </div>	
	<!-- 목록 버튼 -->
	<button class="btn-two mini dark" onclick="goBack()"
			style="position:relative; left:50%; transform:translateX(-50%);width:80px; height:30px; font-size:14px;">
	목목</button>
	<!-- 목록 버튼 끝 -->
</div>
<!-- <button type="button" id="tasksubmitButton">버튼@@@@</button> -->
<!-- <input type="file" name="uploadFiles" id="submitFile" multiple="multiple" /> -->

<script>
	function goBack() { 
	 window.history.back();
	 location.href = "/student/task/list?lecCd=" + ${param.lecCd};
   } 
	
$(function() {
	$("#lecNm").text($(".sub_title").text());
	const formData = new FormData();
	var taskCd = $('#taskCd').val();
	var stuCd = $('#stuCd').val();

	$("#submitFile").change(function() {
		var files = files = $("#submitFile")[0].files;
		for (var i = 0; i < files.length; i++) {
			formData.append("files", files[i]);
		}
	});
	const data = {
		"taskCd" : taskCd,
		"stuCd" : stuCd
	}
	formData.append("taskSubmitVO", new Blob([ JSON.stringify(data) ], {type : "application/json"}));
	$('#tasksubmitButton').on('click', function() {
		$.ajax({
			url : "/student/task/submit",
			type : "post",
			data : formData, 
			processData : false,
			contentType : false,
			beforeSend : function(xhr) {
				xhr.setRequestHeader("${_csrf.headerName}",
						"${_csrf.token}");
			},
			success : function(res) {
				
				var submitDivHtml = `<div style="position:relative; width:300px; height:150px; padding:20px; box-sizing:border-box; border:1px solid #ccc; border-radius:5px; margin-top:20px; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 2px 6px 2px rgba(60,64,67,.15);">
					<div style="display:flex; justify-content:space-between; align-items:end;"><div style="font-size:20px;">과제제출함</div><div style="font-size:15px;">제출완료</div></div>`;
				
			 	for(var i = 0; i < res.length; i++){
			 		submitDivHtml += '<a class="fileLink" href="/resources/upload/' + res[i].fileSvnm + '"  style="margin-top:20px; width:100%; font-size:14px; border:1px solid #ccc; line-height:23px; height:30px; background-color:#fff;border-radius:3px;" download>' + res[0].fileOrnm + '</a>'
			 	}
					
			    submitDivHtml += `
			        <input type="file" name="uploadFiles" id="submitFile" multiple="multiple" style="margin-top:20px; width:100%; font-size:14px; border:1px solid #ccc; line-height:23px; height:30px; background-color:#fff;border-radius:3px;display: none;"/>
			        <button type="button" id="tasksubmitUpdateButton" style="border:1px solid #ccc; border-radius:3px; background-color:#ebebeb; font-size:13px; height:30px; margin-top:5px; line-height:30px; position:absolute; right:20px; bottom:20px;">수정</button>
			        <button type="button" id="tasksubmitUpdateSubmitButton" style="border:1px solid #ccc; border-radius:3px; background-color:#ebebeb; font-size:13px; height:30px; margin-top:5px; line-height:30px; position:absolute; right:20px; bottom:20px;display: none;">제출</button>
			    </div>`;
			    
			    $(".submitDiv").html(submitDivHtml);
			
			},
			error : function(xhr) {
				console.log(xhr);
			}
		});
	});
	$(document).on('click', '#tasksubmitUpdateButton', function(){
		$('#tasksubmitUpdateButton').hide();
		$('.fileLink').hide();
		$('#tasksubmitUpdateSubmitButton').show();
		$('#submitFile').show();
	});
});
</script>