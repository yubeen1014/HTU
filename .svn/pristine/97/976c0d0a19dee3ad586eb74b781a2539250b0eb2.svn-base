let alarmList = [];
let socket = null;

$(function() {
  connectWS();
});

// 소켓
connectWS = function() {
  let ws = new SockJS("http://localhost/echo");
  socket = ws;
  
  ws.onopen = function(userCd) {
    console.log("연결 완료");
    sendMessageToServer("로그인사용자");
  }
  
  ws.onmessage = function(event) {
    
    alarmList = JSON.parse(event.data);
    console.log("alarmList ==>", alarmList);
    
    if (alarmList.length > 0) {
      $(".alarm").append(`<div class="new_alarm_down"></div>`);
    }
    
    $("#mailAlarm").on("click", function() {
      let txt = "";
      let mail = {};
      alarmList.forEach(alarm => {
        if (alarm.commonDetailVO.comdCd == 'ALAM03') {
          const pk = alarm.ntfUrl.split("=")[1];
          $.ajax({
            url: "/mail/getMailByNtfCd?umlCd="+pk,
            type: "get",
            async: false,
            dataType: 'json',
            success: res => {
              mail = res;
            }
          })
          txt += `
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold mb-1">
                  <a href="#" onclick="checkAlarm('${alarm.ntfCd}', '${alarm.ntfUrl}')">${mail.senderNm}님의 ${alarm.commonDetailVO.comdDesc}</a>
                </div>
                ${mail.strUmlReg}
              </div>
            </li>
          `;
        }
      })
      if (txt.length < 1) {
        txt = `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="ms-2 me-auto">
            <div class="fw-bold mb-1">도착한 메일이 없습니다.</div>
          </div>
        </li>
        `;
      }
      $("#notificationList").html(txt);
    });
    
    
    $("#commentAlarm").on("click", function() {
      let txt = "";
      let comment = {};
      alarmList.forEach(alarm => {
        if (alarm.commonDetailVO.comdCd == 'ALAM04' || alarm.commonDetailVO.comdCd == 'ALAM05') {
          
          $.ajax({
            url: "/comment/getCommentByCmtCd?cmtCd="+alarm.ntfUrl.split('=')[2],
            type: "get",
            dataType: "json",
            async: false,
            success: res => {
              comment = res;
              console.log("comment ==> ", comment);
            }
          })
          
          let commentStr = comment.cmtCon;
          if (commentStr.length >= 10) {
            commentStr = commentStr.substr(0,10);
            commentStr += "...";
          }
          
          txt += `
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold mb-1">
                <a href="#" onclick="checkAlarm('${alarm.ntfCd}', '${alarm.ntfUrl}')">\'${comment.boardVO.bdTitle}\' ${alarm.commonDetailVO.comdDesc}</a>
              </div>
              내용 : ${commentStr}
            </div>
          </li>
          `
        }
      })
      if (txt.length < 1) {
        txt = `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="ms-2 me-auto">
            <div class="fw-bold mb-1">댓글 알림이 없습니다.</div>
          </div>
        </li>
        `;
      } 
      $("#notificationList").html(txt);
    })
    
    $("#academicAlarm").on("click", function() {
      
    })
    
    $("#etcAlarm").on("click", function() {
      let txt = "";
      let result = {};
      alarmList.forEach(alarm => {
        if (alarm.commonDetailVO.comdCd == "ALAM09" || alarm.commonDetailVO.comdCd == "ALAM10" ||
            alarm.commonDetailVO.comdCd == "ALAM02") {
          
          $.ajax({
            url: "/common/getCounselByCnslCd?cnslCd=" + alarm.ntfUrl.split("=")[1],
            type: "get",
            dataType: "json",
            async: false,
            success: res => {
              result = res;
              console.log(res);
            },
          })
          txt += `
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold mb-1">
                  <a href="#" onclick="checkAlarm('${alarm.ntfCd}', '${alarm.ntfUrl}')">${result.userVO.userNm} 학생이 상담을 신청하셨습니다.</a>
                </div>
                상담일자 : ${result.cnslCon}
              </div>
            </li>
          `;
        }
      })
      if (txt.length < 1) {
        txt = `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="ms-2 me-auto">
            <div class="fw-bold mb-1">알림이 없습니다.</div>
          </div>
        </li>
        `;
      } 
      $("#notificationList").html(txt);
    })
    
    // const token = $("meta[name='_csrf']").attr("content");
    // const header = $("meta[name='_csrf_header']").attr("content");
    
    // $.ajax({
    //   url: "/getCommonDetail?comCd=ALAM",
    //   type: "get",
    //   beforeSend:function(xhr){
		// 		xhr.setRequestHeader(header,token);
		// 	},
    //   success: (res) => {
    //     console.log("res ==>", res);
        
    //     const comdSet = new Set();
    //     alarmList.forEach(alarm => {
    //       res.forEach(comdVO => {
    //         if (alarm.comdCd == comdVO.comdCd) comdSet.add(comdVO);
    //       })
    //     });
    //     console.log(comdSet);
    //     let txt = '';
    //     comdSet.forEach(item => {
    //       txt += `<li><a href="#none" onclick="alarmDetail('${item.comdCd}')" style="margin-left: 5px;">${item.comdNm}</a></li>`
    //     })
    //     $("#notificationDropdown ul:first").html(txt);
    //   }
    // });
    
  };
  
  ws.onclose = function() {
    console.log("소켓 연결 종료");
  };
};

function checkAlarm(ntfCd, url) {
  
  console.log(ntfCd, url);
  
  $.ajax({
    url: "/notification/check?ntfCd="+ntfCd,
    type: "get",
    success: res => {
      if (res == 1 && url != undefined) location.href=url;
    },
    error: xhr => {
      console.log(xhr);
    }
    
  })
  
}


function sendMessageToServer(message) {
  socket.send(message);
};
