<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.CrewMapper">
	
	<resultMap type="approvalVO" id="approvalMap">
		<result property="appCd" column="APP_CD"/>
		<result property="userCd" column="USER_CD"/>
		<result property="comdCd" column="COMD_CD"/>
		<result property="appTarget" column="APP_TARGET"/>
		<result property="appYn" column="APP_YN"/>
		<result property="appReg" column="APP_REG"/>
		<result property="appProdt" column="APP_PRODT"/>
		<result property="appRet" column="APP_RET"/>
		<result property="appPcd" column="APP_PCD"/>
		<association property="userVO" resultMap="userMap"></association>
	</resultMap>
	
	<resultMap type="studentVO" id="studentMap">
		<result property="stuCd" column="STU_CD"/>
		<result property="depCd" column="DEP_CD"/>
		<result property="comdCd" column="COMD_CD"/>
		<result property="stuYear" column="STU_YEAR"/>
		<result property="stuSem" column="STU_SEM"/>
		<result property="stuMrc" column="STU_MRC"/>
		<result property="stuMoc" column="STU_MOC"/>
		<result property="stuCrc" column="STU_CRC"/>
		<result property="stuCoc" column="STU_COC"/>
		<result property="stuAddt" column="STU_ADDT"/>
		<result property="stuGrdt" column="STU_GRDT"/>
		<association property="userVO" resultMap="userMap"></association>
	</resultMap>
	
	<resultMap type="userVO" id="userMap">
		<result property="userCd" column="USER_CD"/>
		<result property="fileCd" column="FILE_CD"/>
		<result property="userNm" column="USER_NM"/>
		<result property="userNme" column="USER_NME"/>
		<result property="userTel" column="USER_TEL"/>
		<result property="userZip" column="USER_ZIP"/>
		<result property="userAddr1" column="USER_ADDR1"/>
		<result property="userAddr2" column="USER_ADDR2"/>
		<result property="userReg1" column="USER_REG1"/>
		<result property="userReg2" column="USER_REG2"/>
		<result property="userMail" column="USER_MAIL"/>
		<result property="userPass" column="USER_PASS"/>
		<result property="userBank" column="USER_BANK"/>
		<result property="userDepo" column="USER_DEPO"/>
		<result property="userAcc" column="USER_ACC"/>
		<result property="comdCd" column="COMD_CD"/>
	</resultMap>
	
	<resultMap type="buildingVO" id="buildingMap">
		<result property="bldCd" column="BLD_CD"/>
		<result property="colCd" column="COL_CD"/>
		<result property="bldZip" column="BLD_ZIP"/>
		<result property="bldAddr1" column="BLD_ADDR1"/>
		<result property="bldAddr2" column="BLD_ADDR2"/>
	</resultMap>
	
	<resultMap type="roomVO" id="roomMap">
		<result property="roomCd" column="ROOM_CD"/>
		<result property="bldCd" column="BLD_CD"/>
		<result property="roomPur" column="ROOM_PUR"/>
		<result property="roomCap" column="ROOM_CAP"/>
		<result property="roomTel" column="ROOM_TEL"/>
		<association property="buildingVO" resultMap="buildingMap"></association>
	</resultMap>
	
	<resultMap type="commonDetailVO" id="commonDetailMap">
		<result property="comdCd" column="COMD_CD"/>
		<result property="comCd" column="COM_CD"/>
		<result property="comdNm" column="COMD_NM"/>
		<result property="comdDesc" column="COMD_DESC"/>
	</resultMap>
	
	<resultMap type="filesDetailVO" id="filesDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileCd" column="FILE_CD"/>
		<result property="filePath" column="FILE_PATH"/>
		<result property="fileOrnm" column="FILE_ORNM"/>
		<result property="fileSvnm" column="FILE_SVNM"/>
		<result property="fileExtsn" column="FILE_EXTSN"/>
		<result property="fileCon" column="FILE_CON"/>
		<result property="fileSize" column="FILE_SIZE"/>
	</resultMap>
	
	<resultMap type="crewPersonnelVO" id="crewPersonnelMap">
		<result property="crCd" column="CR_CD"/>
		<result property="stuCd" column="STU_CD"/>
		<result property="appCd" column="APP_CD"/>
		<result property="crpJoin" column="CRP_JOIN"/>
		<result property="crpQuit" column="CRP_QUIT"/>
	</resultMap>
	
	<resultMap type="crewVO" id="crewMap">
		<result property="crCd" column="CR_CD"/>
		<result property="roomCd" column="ROOM_CD"/>
		<result property="appCd" column="APP_CD"/>
		<result property="stuCd" column="STU_CD"/>
		<result property="fileCd" column="FILE_CD"/>
		<result property="crLeader" column="CR_LEADER"/>
		<result property="crNm" column="CR_NM"/>
		<result property="crYn" column="CR_YN"/>
		<result property="ldrNm" column="LDR_NM"/>
		<result property="stuNm" column="STU_NM"/>
		<result property="roomNm" column="ROOM_NM"/>
		<association property="studentVO" resultMap="studentMap"></association>
		<collection property="filesDetailVOList" resultMap="filesDetailMap"></collection>
<!-- 		<association property="approvalVO" resultMap="approvalMap"></association> -->
<!-- 		<association property="roomVO" resultMap="roomMap"/> -->
<!-- 		<association property="commonDetailVO" resultMap="commonDetailMap"/> -->
	</resultMap>
	
	<!-- 동아리 조회 -->
	<select id="crewList" resultMap="crewMap">
		SELECT A.CR_CD, A.ROOM_CD, A.APP_CD, A.CR_NM
		       , SUBSTR(C.ROOM_CD, 7) || '호' ROOM_NM, B.USER_NM LDR_NM
		FROM   CREW A, USERS B, ROOM C
		WHERE  A.CR_LEADER = B.USER_CD
		AND    A.ROOM_CD = C.ROOM_CD
		AND    A.CR_YN = '0'
	</select>
	
	<!-- 동아리 개설 신청 -->
	<insert id="crewApply" parameterType="crewVO">
		<selectKey resultType="String" order="BEFORE" keyProperty="crCd">
			SELECT 'CREW' || TRIM(TO_CHAR(CREW_SEQ.NEXTVAL, '00'))
			FROM   DUAL
		</selectKey>
		INSERT INTO CREW(CR_CD, ROOM_CD, STU_CD, APP_CD, CR_LEADER, CR_NM)
		VALUES(#{crCd}, #{roomCd}, #{stuCd}, #{appCd}, #{crLeader}, #{crNm})
	</insert>
	
	<update id="crewUpdateYn" parameterType="crewVO">
		UPDATE CREW
	 	SET    CR_YN = 0
	 	WHERE  APP_CD = #{appCd}
	</update>
	
	<!-- 동아리원 등록 -->
	<insert id="crewJoinApp" parameterType="crewPersonnelVO">
		INSERT INTO CREW_PERSONNEL(CR_CD, STU_CD, APP_CD, CRP_JOIN)
		VALUES(#{crCd}, #{stuCd}, #{appCd}, SYSDATE)
	</insert>
	
	<!-- 나의 동아리 -->
	<select id="myCrew" parameterType="String" resultMap="crewMap">
		SELECT A.CR_CD, A.ROOM_CD, A.CR_LEADER, A.CR_NM
			   , SUBSTR(C.ROOM_CD, 7) || '호' ROOM_NM, D.USER_NM LDR_NM
		FROM   CREW A, CREW_PERSONNEL B, ROOM C, USERS D
		WHERE  A.CR_CD = B.CR_CD
		AND    B.CRP_QUIT IS NULL
		AND    A.ROOM_CD = C.ROOM_CD
		AND	   A.CR_LEADER = D.USER_CD
		AND    B.STU_CD = #{stuCd}
	</select>
	
	<select id="crewDetail" parameterType="String" resultMap="crewMap">
<!-- 		SELECT A.CR_CD, A.ROOM_CD, A.APP_CD, A.CR_LEADER, A.CR_NM -->
<!-- 		       , SUBSTR(C.ROOM_CD, 7) || '호' ROOM_NM, B.USER_NM LDR_NM  -->
<!-- 		FROM   CREW A, USERS B, ROOM C -->
<!-- 		WHERE  A.CR_LEADER = B.USER_CD -->
<!--         AND    A.ROOM_CD = C.ROOM_CD -->
<!--         AND    A.CR_CD =  #{crCd} -->
		SELECT
		    A.CR_CD, A.ROOM_CD, A.APP_CD, A.STU_CD, A.CR_LEADER, A.CR_NM, A.CR_YN
		    , SUBSTR(B.ROOM_CD, 7) || '호' ROOM_NM
		    , C.FILE_SN, C.FILE_CD, C.FILE_PATH, C.FILE_ORNM, C.FILE_SVNM, C.FILE_EXTSN, C.FILE_CON, C.FILE_SIZE
		    , D.USER_NM LDR_NM 
		FROM
		    CREW A 
		    LEFT JOIN ROOM B ON A.ROOM_CD = B.ROOM_CD
		    LEFT JOIN FILES_DETAIL C ON A.CR_CD = C.FILE_CD
		    LEFT JOIN USERS D ON A.CR_LEADER = D.USER_CD
		WHERE
		    A.CR_CD = #{crCd}
	</select>
	
	<select id="crewPersonnel" parameterType="String" resultMap="crewMap">
		SELECT A.STU_CD, B.USER_NM STU_NM 
		FROM   CREW_PERSONNEL A, USERS B
		WHERE  A.STU_CD = B.USER_CD
		AND    A.CRP_QUIT IS NULL
		AND    A.CR_CD = #{crCd}
	</select>
	
	<select id="crewJoinYn" parameterType="String" resultMap="crewPersonnelMap">
		SELECT A.APP_CD, A.USER_CD, A.COMD_CD, A.APP_TARGET, A.APP_YN
		       , B.CR_CD, B.CR_LEADER, B.CR_NM
		FROM   APPROVAL A, CREW B 
		WHERE  A.APP_TARGET = B.CR_LEADER 
		AND    B.CR_CD = #{crCd}
		AND    A.COMD_CD = 'APPR03'
		AND    A.USER_CD = #{crCd}
	</select>
	
	<update id="crewUpdate">
		UPDATE CREW
		SET	   CR_NM = #{crNm}
			   , CR_LEADER = #{crLeader}
		       , ROOM_CD = #{roomCd}
		WHERE  CR_CD = #{crCd}
	</update>
	
	<update id="crewQuit" parameterType="String">
		UPDATE CREW_PERSONNEL
		SET	   CRP_QUIT = SYSDATE
		WHERE  CR_CD = #{crCd}
        AND    STU_CD = #{stuCd}
	</update>
	
</mapper>