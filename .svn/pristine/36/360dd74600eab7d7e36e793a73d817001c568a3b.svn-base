<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<script src="/resources/js/jquery.min.js"></script>
<style>
	.crewDetail {width: 100%; height: 100%;}
	.crewIndex {width: 100%; height: 100%;}
	.crewIndex a{color:#333333!important; text-decoration:none!important;}
	.crewIndex a:hover{color:#333333!important; text-decoration:none!important;}
	.crewHeader {font-size: 24px; padding-bottom: 30px; position: relative;}
	#appBtn, #btnQuit, #btnApply {position: absolute; right: 0; bottom: 0;}
	.crewDivbox {width: 100%; display: inline-flex;height: 35%; margin-bottom: 10px;}
	.crewDiv1 {width: 40%; margin-right: 10px;}
	.crewDiv2 {width: 60%;}
	.crewInfo {border-radius : 5px; position: relative; height: 100%; padding: 40px; 
		margin-bottom: 10px; background-color: #ffffff; overflow: auto;}
	.crewInfoTbl {width: 100%; height: 80%;}
	.crewInfoHeader {font-size: 18px; padding-bottom: 20px;}
	.crewInfoTbl-title {padding-right: 5px; font-weight: bold;}
	.crewInfoTbl a{border: 1px solid #eaeaea; border-radius: 5px; font-size: 14px; padding: 5px;}
	.crewInfoTbl tr:last-child{padding: 300px;}
	.crewModBtn {position: absolute; width: 20px; height: 20px; right: 13px; bottom: 13px;}
	.crewManage {border-radius : 5px; padding: 15px 13px; background-color: #ffffff; 
		overflow: auto;}
/* ---------------------------------------------------------------------------- */
	.crew_box{width:60%; padding:40px; background-color:#ffffff;}
	.crew_box .table_topic{font-size: 18px; padding-bottom:30px;}
	.crew_box table{font-size:14px; width:100%; text-align:center;}
	.table_title{font-size:13px; border-top:1px solid #d1d0d0; border-bottom:1px solid #d1d0d0; height:32px; line-height:32px;}
	.crew_box tr{height: 40px;}
	.crew_box tr td:nth-child(1){width:10%;}
	.crew_box tr td:nth-child(2){width:30%;}
	.crew_box tr td:nth-child(3){width:40%;}
	.crew_box tr td:nth-child(4){width:20%;}
/* ---------------------------------------------------------------------------- */
	.crewPerson {border-radius : 5px; height: 100%; padding: 15px 25px; margin-bottom: 10px;
		background-color: #ffffff;}
	.crTb{height: 80%; overflow: auto;}
	.crewPersonTbl {width: 100%; text-align: center; border-spacing: 30px; line-height: 3rem;}
	.crewPerson-tr {border-bottom: 1px solid #eaeaea; padding: 30px 0;}
	.crewPersonTbl tr:last-child {border:none;}
	.crewPersonTbl th {position: sticky; top: 0px; background-color : #eaeaea;}
	.crewfiles {display: inline-flex; width: 400px;}
	.crewfiles img {display:block; padding: 0 5px;
 	  max-width:100%;
      width: auto;
 	  height:auto;
	}
	#crewActBtn {font-size: 24px; padding-top: 30px; float: right;}
	.crewActivityHeader {font-size: 18px;  padding-top: 15px; padding-left: 10px;}
	.crewAct {width: 100%;  border-bottom: 1px solid gray; padding: 20px; overflow: auto;}
	.actStuNm {font-size: 18px; font-weight: bold;}
	.crewAct p {padding: 10px 0;}
	#craAddBtn {float: right; padding-right: 30px;}
	.joinAppTbl {width: 100%; height: 80%; text-align: center; border-spacing: 30px;}
	.joinAppTbl tr {border-bottom: 1px solid #eaeaea; padding: 30px 0;}
	.joinAppTbl tr:last-child {border:none;}
	ul.tabs{margin: 0px; padding: 0px; list-style: none;}
	ul.tabs li{border-radius: 5px 5px 0 0; background: #eaeaea; color: #222;
		display: inline-block; padding: 10px 15px; cursor: pointer;}
	ul.tabs li.current{border-radius: 5px 5px 0 0; background: #ffffff; color: #222;}
	.tab-content{display: none; background: #ffffff; padding: 15px;}
	.tab-content.current{display: inherit;}
 	#appRet {width: 100%; height: 80%; font-size: 15px; border: 0; border-radius: 15px;
 		outline: none; padding: 15px; background-color: rgb(233, 233, 233); resize: none;}
	#appModal {z-index: 998; position:absolute;  width:100%;  height:100%; background: rgba(0,0,0,0.4); 
		top:0; left:0; display:none;}
	.appModal-content {background-color: #ffffff; border-radius: 5px; margin: 15% auto;
		padding: 20px; width: 40%; height: 60%;}
 	.rtnBtn, .closeBtn, .craBtn { float: right;} 
 	#rtnModal {z-index: 999; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.4); 
 		top: 0; left: 0; display: none;} 
 	.rtnModal-content {background-color: #ffffff; border-radius: 5px; margin: 15% auto;
 		padding: 20px; width: 40%; height: 60%;} 
 	.rtnReason, .craAdd, .joinApp {padding: 10px; font-size: 20px;} 
 	#craModal {z-index: 999; position: absolute;  width: 100%;   height: 100%; 
  		background: rgba(0,0,0,0.4); top: 0; left: 0; display: none;} 
 	.craModal-content {background-color: #ffffff; border-radius: 5px; margin: 15% auto;
		padding: 20px; width: 40%; height: 60%;}
 	.craDate {font-size: 18px; padding: 20px; resize: none;} 
 	#craCon {width: 100%; height: 70%; font-size: 15px; border: 0; border-radius: 15px;
 		outline: none; padding: 15px; background-color: rgb(233, 233, 233); resize: none;}
</style>
<sec:authentication property="principal.userVO" var="userVO"/>
<input id="crCd" value="${crewVO.crCd}" hidden />
<!-- ///////////////////////////////////////// MODAL ///////////////////////////////////////// -->	
<!-- 반려 사유 모달 -->
<div id="rtnModal">
	<div class="rtnModal-content">
		<p class="rtnReason">반려 사유</p>
		<textarea id="appRet" maxlength=1000 required="required"></textarea>
		<div>
			<button type="button" class="rtnBtn btn-reg bur" id="rtnBtn" style="padding-right: 10px;">확인</button>
			<button type="button" class="closeBtn btn-reg back" id="closeBtn">닫기</button>
		</div>
	</div>
</div>

<div id="appModal">
	<div class="appModal-content">
		<div>
			<p class="joinApp">동아리 가입 신청</p>
		</div>
		<table class="joinAppTbl">
			<tr>
				<td>학번</td>
				<td>이름</td>
				<td></td>
			</tr>
			<c:forEach var="approvalVO" items="${approvalVOList}">
			    <tr>
					<c:if test="${approvalVOList eq null}">
						<td>확인하지 않은 가입 신청이 없습니다.</td>
					</c:if>
			        <td>${approvalVO.approvalVO.userCd}</td>
			        <td>${approvalVO.stuNm}</td>
		            <td>
		            	<button type="button" class="btnApp btn-two sky mini" data-app-cd="${approvalVO.appCd}" data-user-cd="${approvalVO.approvalVO.userCd}">승인</button>
		            	<button type="button" class="btnRtn btn-two blue mini" data-app-cd="${approvalVO.appCd}" data-user-cd="${approvalVO.approvalVO.userCd}">반려</button>
		            </td>
			    </tr>
			</c:forEach>
		</table>
		<button type="button" class="closeBtn btn-two red mini">닫기</button>
	</div>
</div>

<div id="craModal">
	<div class="craModal-content">
		<p class="craAdd">새 활동 추가</p>
		<div class="craDate">
			<p>시작 <input type="date" id="stDate" /><input type="time" value="12:00:00" id="stTime" /></p>
			<p>종료 <input type="date" id="edDate" /><input type="time" value="12:00:00" id="edTime" /></p>
		</div>
		<textarea id="craCon" maxlength=1000 required="required"></textarea>
		<div>
			<button type="button" class="craBtn btn-two red mini" id="craBtn">등록</button>
			<button type="button" class="closeBtn btn-two gray mini" id="closeBtn">닫기</button>
		</div>
	</div>
</div>
<!-- ///////////////////////////////////////// MODAL ///////////////////////////////////////// -->
<!-- <div class="crewDetail" style="border: 3px solid blue;"> -->
<div class="crewDetail">
	<div class="crewHeader">
		${crewVO.crNm}
		<c:if test="${crewVO.crLeader eq userVO.userCd}">
			<button type="button" class="btn-two red mini" id="appBtn">가입 신청 확인</button>
		</c:if>
		<c:if test="${crewVO.crLeader ne userVO.userCd}">
			<c:choose>
			    <c:when test="${crVO ne null and not empty crVO}">
	                <button type="button" id="btnQuit" class="btn-two red mini">탈퇴</button>
			    </c:when>
			    <c:otherwise>
	            	<button type="button" id="btnApply" data-stu-cd="${crewVO.stuCd}" class="btn-two red mini">가입</button>
			    </c:otherwise>
			</c:choose>
		</c:if>
	</div>
<!-- 	<div class="crewIndex" style="border: 3px solid red;"> -->
	<div class="crewIndex">
<!-- 		<div class="crewDivbox" style="border: 3px solid pink;"> -->
		<div class="crewDivbox">
			<div class="crewDiv1">
				<div class="crewInfo">
					<div class="crewInfoHeader">
						<p>동아리 소개</p>
					</div>
					<table class="crewInfoTbl">
						<tr>
							<td class="crewInfoTbl-title">동아리 목적</td>
							<td>${crewVO.crCon}</td>
						</tr>
						<tr>
							<td class="crewInfoTbl-title">동아리실</td>
							<td>학생회관 ${crewVO.roomNm}</td>
						</tr>
						<tr>
							<td class="crewInfoTbl-title">인원</td>
							<td>${crewVO.crPs}</td>
						</tr>
						<tr>
							<td class="crewInfoTbl-title">회장</td>
							<td>${crewVO.ldrNm}</td>
						</tr>
						<tr>
							<td class="crewInfoTbl-title">전화번호</td>
							<td>${crewVO.userVO.userTel}</td>
						</tr>
						<tr>
							<td>
								<a href="#none">Instagram →</a>
								<a href="#none">Youtube →</a>
							</td>
						</tr>
					</table>
					<c:if test="${crewVO.crLeader eq userVO.userCd}">
						<div>
							<a href="/student/crew/crewUpdate?crCd=${crewVO.crCd}">
								<img class="crewModBtn" src="/resources/images/gear.png" alt="crewManage" />
							</a>
						</div>
					</c:if>
				</div>
			</div>
			<div class="crew_box">
				<div class="table_topic">동아리원</div>
				<div class="crTb">
					<table>
						<tr class="table_title">
							<th>번호</th>
							<th>학번</th>
							<th>학과</th>
							<th>이름</th>
						</tr>
						<c:forEach var="crewPerson" items="${crewPersonnelList}" varStatus="stat">
							<tr>
								<td>${stat.count}</td>
								<td>${crewPerson.stuCd}</td>
								<td>${crewPerson.depNm}</td>
								<td>${crewPerson.stuNm}</td>
							</tr>
						</c:forEach>
					</table>
				</div>
			</div>
		</div>
			
		<div class="crewContent">
			<div class="crewContentTab">
				<ul class="tabs">
					<li class="tab-link current" data-tab="tab-1">HOME</li>
					<li class="tab-link" data-tab="tab-2">동아리 활동</li>
				</ul>
				
				<div id="tab-1" class="tab-content current">
					<div class="crewfiles">
						<c:forEach var="fileDetail" items="${crewVO.filesDetailVOList}">
							<img alt="" src="/resources/upload/${fileDetail.fileSvnm}">
			    		</c:forEach>
					</div>
				</div>
				<div id="tab-2" class="tab-content">
					<div class="crewActivity">
						<div class="crewActivityHeader">
							동아리 활동
							<a type="button" id="craAddBtn"><img src="/resources/images/plus.png" style="width: 20px; height: 20px; left: 10px;"/></a>
						</div>
						<c:forEach var="actVO" items="${crewActVOList}"> 
							<div class="crewAct">
								<p class="actStuNm">${actVO.stuNm}</p>
								<p>${actVO.craCon}</p>
								<p><fmt:formatDate value="${actVO.craStdt}" pattern="yyyy년 MM월 dd일 HH시 mm분"/> - 
								<fmt:formatDate value="${actVO.craEddt}" pattern="yyyy년 MM월 dd일 HH시 mm분"/></p>
							</div>
						</c:forEach>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
$(function(){
	
	$("#appBtn").on("click", function(){
		
		$(".crewModBtn").css("display", "none");
		$(".crewPersonTbl th").css("position", "static");
		$(".crewInfo").css("position", "static");

        $("#appModal").fadeIn();

        $(".closeBtn").on("click", function(){
        	$("#appModal").fadeOut();
        	$(".crewPersonTbl th").css("position", "sticky");
    		$(".crewInfo").css("position", "relative");
    		$(".crewModBtn").css("display", "");
        });
        
		//승인 버튼 클릭 시
		$(".btnApp").on("click", function(){
			let appCd = $(this).data("appCd");
			let userCd = $(this).data("userCd");
			let crCd = "${crewVO.crCd}";
			
			console.log("appCd : ", appCd);
			console.log("userCd : ", userCd);
			console.log("crCd : ", crCd);
	        
			$.ajax({
				url:"/student/crew/crewJoinApp",
				data:{
					appYn : 1,
					appCd : appCd,
					userCd : userCd,
					crCd : crCd
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					$("#appModal").fadeOut();
					$(".crewPersonTbl th").css("position", "sticky");
		    		$(".crewInfo").css("position", "relative");
		    		$(".crewModBtn").css("display", "");
					alertSuccess('승인되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
				}
			});
		});
		
		//반려 버튼 클릭 시
	 	$(".btnRtn").on("click", function(){
 			$("#appModal").css("display", "none");
	        $("#rtnModal").show();
			
	 		let appCd = $(this).data("appCd");
	 		let userCd = $(this).data("userCd");
	 		let crCd = "${crewVO.crCd}";
	 		
	 		console.log("appCd : ", appCd);
			console.log("userCd : ", userCd);
			console.log("crCd : ", crCd);

	         $("#closeBtn").on("click", function(){
	         	$("#rtnModal").fadeOut();
	         	$(".crewPersonTbl th").css("position", "sticky");
	    		$(".crewInfo").css("position", "relative");
	    		$(".crewModBtn").css("display", "");
	         });
	        
	         $("#rtnBtn").on("click", function(){
	 	        let appRet = $("#appRet").val();
		        
	 	        console.log("appRet: " + appRet);
		        
	             $.ajax({
	                 url: "/student/crew/crewReturn",
	                 data: {
	                     appYn: 2,
	                     appCd : appCd,
	                     userCd: userCd,
	                     crCd: crCd,
	                     appRet: appRet
	                 },
	                 type: "post",
	                 beforeSend: function(xhr) {
	                     xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
	                 },
	                 success: function(res) {
	 		             $("#rtnModal").fadeOut();
	 		             $(".crewPersonTbl th").css("position", "sticky");
	 		    		 $(".crewInfo").css("position", "relative");
	                     alertSuccess('반려 처리되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
	                 }
	             });
	         });
	     });
    });
	
	//탭
	$('ul.tabs li').click(function(){
		var tab_id = $(this).attr('data-tab');

		$('ul.tabs li').removeClass('current');
		$('.tab-content').removeClass('current');

		$(this).addClass('current');
		$("#"+tab_id).addClass('current');
	});
	
	//가입 버튼
	$("#btnApply").on("click", function(){
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		let crLeader = "${crewVO.crLeader}";
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		console.log("crLeader : " + crLeader);
		
		if(confirm("가입하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewJoin",
				data:{
					stuCd: stuCd,
					crCd: crCd,
					crLeader: crLeader
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					if(res == null){
						alertError('이미 신청하였습니다.', '/student/crew/crewDetail?crCd='+crCd);
					}else{
						alertSuccess('신청되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
					}
				}
			});
		}
	});
	
	//탈퇴 버튼
	$("#btnQuit").on("click", function(){
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		
		if(confirm("탈퇴하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewQuit",
				data:{
					stuCd:stuCd,
					crCd:crCd
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					alertSuccess('정상적으로 탈퇴 처리되었습니다.', '/student/crew/myCrew');
				}
			});
		}
	});
	
	//동아리 활동 추가
	$("#craAddBtn").on("click", function(){
		
		$(".crewModBtn").css("display", "none");
		$(".crewPersonTbl th").css("position", "static");
		$(".crewInfo").css("position", "static");

        $("#craModal").fadeIn();

        $(".closeBtn").on("click", function(){
        	$("#craModal").fadeOut();
        	$(".crewPersonTbl th").css("position", "sticky");
    		$(".crewInfo").css("position", "relative");
    		$(".crewModBtn").css("display", "");
        });
        
		//등록 버튼 클릭 시
        $("#craBtn").on("click", function(){
        	let crCd = $("#crCd").val();
        	let craCon = $("#craCon").val();
    		let stdt = $("#stDate").val() + " " + $("#stTime").val();
    		let eddt = $("#edDate").val() + " " + $("#edTime").val();
    		
    		craStdt = new Date(stdt)
    		craEddt = new Date(eddt)
    		
    		console.log("crCd : " + crCd);
    		console.log("craCon : " + craCon);
    		console.log("craStdt : " + craStdt);
    		console.log("craEddt : " + craEddt);
    		
    		let data = {
   				"crCd" : crCd,
    			"craCon" : craCon,
    			"craStdt" : craStdt,
    			"craEddt" : craEddt
    		}
        
			$.ajax({
				url:"/student/crew/addCrewActivity",
				contentType:"application/json;charset=utf-8",
				data:JSON.stringify(data),
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					$("#craModal").fadeOut();
					$(".crewPersonTbl th").css("position", "sticky");
		    		$(".crewInfo").css("position", "relative");
		    		$(".crewModBtn").css("display", "");
					alertSuccess('새 활동이 등록되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
				}
			});
		});
	});
});
</script>