<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<script src="/resources/js/jquery.min.js"></script>
<style>

.dataTables_paginate paging_simple_numbers {
	margin: 0 auto;
}

.col-sm-12 col-md-7 {
	margin: 0 auto;
}

#searchForm {
	position: absolute;
	left: 76%;
	top: 40px;
	display: flex;
	align-items: center;
	background-color: #f5f5f5;
	border-radius: 5px;
	padding: 5px;
}

#searchForm select, #searchForm input {
	height: 30px;
	margin-right: 5px;
	border: 1px solid #dedede;
	border-radius: 3px;
	font-size: 14px;
	padding: 0 5px;
}

#searchForm select {
	color: #333;
}

#searchForm input {
	background-color: #fff;
}

#searchForm button {
	border: none;
	color: #fff;
	cursor: pointer;
	border-radius: 5px;
	padding: 0 10px;
	display: flex;
	align-items: center;
	justify-content: center;
}

#searchForm button i {
	margin-right: 5px;
}

#searchForm label {
	margin-right: 10px;
	font-size: 14px;
	color: #333;
}

.pagination {
	display: flex;
	justify-content: center;
	list-style: none; /* 추가된 부분 */
	padding: 0; /* 추가된 부분 */
}

.pagination li {
	margin: 0 5px;
}

.pagination a {
	text-decoration: none;
	color: #333;
	font-weight: bold;
	padding: 5px 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	cursor: pointer;
}

.page-navigation {
	position: absolute;
	left: -8%;
	bottom: 1%;
	width: 100%;
	text-align: center;
}
.mail_toolbar {
	margin-left: 25px;
	padding: 10px;
	webkit-box-flex: 0;
	-webkit-flex: 0 0 auto;
	flex: 0 0 auto;
	position: relative;
	top: auto;
	right: auto;
	left: auto;
	margin: 0 25px;
	-webkit-box-flex: 0;
	flex: 0 0 auto;
	position: relative;
	top: auto;
	right: auto;
	left: auto;
	-webkit-box-align: center;
	align-items: center;
	border-top: 1px solid #ddd;
	justify-content: space-between;
}

.mail_toolbar.type_write {
	display: flex;
	flex-wrap: wrap;
	height: 50px;
	margin: 0px;
}
.mail_toolbar_task {
	display: flex;
}
.mail_btn {
	width: 70px;
	margin: 0 5px 0 9px;
	padding: 3px 10px;
	outline: none;
	line-height: 20px;
	background-color: transparent;
 	cursor: pointer;
	touch-action: manipulation;
	border: 0;
}
.button_group_mail {
	display: flex;
	padding-left: 10px;
    justify-content: space-evenly;
    
}
</style>
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" href="/resources/test/fonts/icomoon/style.css">

<!-- Style -->
<link rel="stylesheet" href="/resources/test/css/style.css">
</head>
<body>
	<sec:authentication property="principal.userVO" var="userVO" />
	<div class="divMailbox">
		<div class="mailHeader">
			<div class="mailHeaderName">받은 메일함</div>
			<!------- 검색기능 ------->
			<form id="searchForm" action="/mail/inbox" method="get"
				style="position: relative; left: 250%; top: 40px;">
				<select name="type">
					<option value=""
						<c:out value='${pageMaker.cri.type == null? "selected": ""}'/>>선택</option>
					<option value="T"
						<c:out value='${pageMaker.cri.type eq "T"?"selected": "" }'/>>제목</option>
					<option value="C"
						<c:out value='${pageMaker.cri.type eq "C"?"selected": "" }'/>>내용</option>
					<option value="W"
						<c:out value='${pageMaker.cri.type eq "W"?"selected": "" }'/>>작성자</option>
				</select> <input type="text" name="keyword" style="border: 1px solid #ccc;"
					value="<c:out value='${pageMaker.cri.keyword}'/>"> <input
					type="hidden" name="pageNum"
					value="<c:out value='${pageMaker.cri.pageNum}'/>"> <input
					type="hidden" name="amount"
					value="<c:out value='${pageMaker.cri.amount}' />">
				<button class="btn btn-default"
					style="border: 1px solid #000; color: #000; position: absolute; top: 12px; right: -52px;">
					<a style="position: relative; top: 0px;">검색</a>
				</button>
			</form>
			<!------- 검색기능 끝------->
		</div>
		<div class="containerMail">
<!-- ----------------------------------------------------------------------------- -->
	<div class="mail_toolbar type_write">
		<div class="mail_toolbar_task">
			<label class="control control--checkbox">
				<input type="checkbox" class="js-check-all" name="mailCheck"/>
				<div class="control__indicator"></div>
	        </label>
			<div class="button_group_mail">
				<div class="button_task_wrap">
					<button id="btnRead" class="mail_btn" type="button" style="padding-left: 20px;">
						<span class="text" style="font-weight: bold; font-size: 14px;">읽음</span>
					</button>
				</div>
				<div class="button_task_wrap">
					<button id="btnDelete" class="mail_btn" type="button" onclick="deleteCheck()">
						<span class="text" style="font-weight: bold; font-size: 14px;">삭제</span>
					</button>
				</div>
			</div>
		</div>
	</div>
<!-- ----------------------------------------------------------------------------- -->	
			<table class="table custom-table">
<!-- 				<thead> -->
<!-- 					<tr> -->
<!-- 						<th scope="col" style="width: 2px;"><label -->
<!-- 							class="control control--checkbox"> <input type="checkbox" -->
<!-- 								class="js-check-all" name="mailCheck" /> -->
<!-- 								<div class="control__indicator"></div> -->
<!-- 						</label></th> -->
<!-- 						<th><a type="button" onclick="readCheck()">읽음</a> <a -->
<!-- 							type="button" onclick="deleteCheck()">삭제</a></th> -->
<!-- 					</tr> -->
<!-- 				</thead> -->
				<tbody>
					<c:forEach var="univMailVO" items="${data}">
						<tr>
							<th scope="row"><label class="control control--checkbox">
									<input type="checkbox" name="mailCheck"
									data-uml-cd="${univMailVO.umlCd}" />
									<div class="control__indicator"></div>
							</label></th>
							<td  style="width: 50px;">
								<c:if test="${univMailVO.umlYn eq 0}">
						       		<svg xmlns="http://www.w3.org/2000/svg" height="17" width="17" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--><path fill="#707070" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg>
									
								</c:if> 
								<c:if test="${univMailVO.umlYn eq 1}">
							       	<svg xmlns="http://www.w3.org/2000/svg" height="17" width="17" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--><path fill="#707070" d="M64 208.1L256 65.9 448 208.1v47.4L289.5 373c-9.7 7.2-21.4 11-33.5 11s-23.8-3.9-33.5-11L64 255.5V208.1zM256 0c-12.1 0-23.8 3.9-33.5 11L25.9 156.7C9.6 168.8 0 187.8 0 208.1V448c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V208.1c0-20.3-9.6-39.4-25.9-51.4L289.5 11C279.8 3.9 268.1 0 256 0z"/></svg>
								</c:if>
							</td>
							<td style="width: 15%;">${univMailVO.userVO.userNm}</td>
							<td style="width: 60%;"><a class="mailTitle"
								href="/mail/receiveDetail?umlCd=${univMailVO.umlCd}">${univMailVO.umlTitle}</a>
							</td>
							<td class="mailTbl-center" style="text-align: right;"><fmt:formatDate pattern="MM월 dd일 HH:mm" value="${univMailVO.umlReg}" /></td>
							<td style="text-align: right; width: 10px;"><img src="/resources/images/x.png" style="width: 10px; height: 10px;" class="deleteMail" data-uml-cd="${univMailVO.umlCd}" /></td>
						</tr>
					</c:forEach>
				</tbody>
			</table>
			<!-- 페이지 시작 -->
<!-- 			<nav class="page-navigation"> -->
<!-- 				<ul class="pagination"> -->
<%-- 					<c:if test="${pageMaker.prev}"> --%>
<!-- 						<li class="paginate_button previous"><a class="page-link" -->
<%-- 							href="${pageMaker.startPage - 1}">이전 페이지</a></li> --%>
<%-- 					</c:if> --%>
					
<%-- 					<c:forEach var="num" begin="${pageMaker.startPage + 1}" --%>
<%-- 						end="${pageMaker.endPage + 1}"> --%>
<!-- 						<li class="paginate_button"><a class="page-link" -->
<%-- 							href="${num}">${num}</a></li> --%>
<%-- 					</c:forEach> --%>

<%-- 					<c:if test="${pageMaker.next}"> --%>
<!-- 						<li class="paginate_button next"><a class="page-link" -->
<%-- 							href="${pageMaker.endPage + 1}">다음 페이지</a></li> --%>
<%-- 					</c:if> --%>
<!-- 				</ul> -->
<!-- 			</nav> -->
			<!-- 페이지 끝 --> 

 			<!-- 페이지 폼 시작 --> 
<!-- 			<form id='actionForm' action="/mail/inbox" method="get"> -->
<%-- 				<input type="hidden" name="pageNum" value="${pageMaker.cri.pageNum}"> --%>
<%-- 				<input type="hidden" name="amount" value="${pageMaker.cri.amount}"> --%>
<!-- 				<input type="hidden" name="type" -->
<%-- 					value="<c:out value='${pageMaker.cri.type}'/>"> <input --%>
<!-- 					type="hidden" name="keyword" -->
<%-- 					value="<c:out value='${pageMaker.cri.keyword}'/>"> --%>
<!-- 			</form> -->
			<!-- 페이지 폼 끝 -->
		</div>
	</div>
	<script src="/resources/test/js/jquery-3.3.1.min.js"></script>
	<script src="/resources/test/js/popper.min.js"></script>
	<script src="/resources/test/js/bootstrap.min.js"></script>
	<script src="/resources/test/js/main.js"></script>
</body>
<script type="text/javascript">
$(function() {
	$("#btnRead").on("click", function(){
		let readArr = [];

		$('input:checkbox[name=mailCheck]').each(function(index) {
			if ($(this).is(":checked") == true) {
				readArr.push($(this).data("umlCd"));
			}
		});

		console.log("readArr:", readArr);

		$.ajax({
			url : "/mail/readCheck",
			contentType : "application/json; charset=utf-8",
			data : JSON.stringify(readArr),
			type : "post",
			beforeSend : function(xhr) {
				xhr.setRequestHeader("${_csrf.headerName}",
						"${_csrf.token}");
			},
			success : function(res) {
				console.log("읽음!");
				location.reload();
			}
		});
	});

	$("#btnDelete").on("click", function(){
		let deleteArr = [];

		$('input:checkbox[name=mailCheck]').each(function(index) {
			if ($(this).is(":checked") == true) {
				deleteArr.push($(this).data("umlCd"));
			}
		});

		if(confirm("삭제하시겠습니까?")){
			
			$.ajax({
				url : "/mail/deleteCheck",
				contentType : "application/json; charset=utf-8",
				data : JSON.stringify(deleteArr),
				type : "post",
				beforeSend : function(xhr) {
					xhr.setRequestHeader("${_csrf.headerName}",
							"${_csrf.token}");
				},
				success : function(res) {
					console.log("삭제!");
					location.reload();
				}
			});
		}
	});
	

	$(".deleteMail").on("click", function() {
		if (confirm("삭제하시겠습니까?")) {
			let umlCd = $(this).data("umlCd");
			console.log("umlCd : " + umlCd);

			$.ajax({
				url : "/mail/deleteReceiveMail?umlCd=" + umlCd,
				data : umlCd,
				type : "post",
				beforeSend : function(xhr) {
					xhr.setRequestHeader("${_csrf.headerName}",
							"${_csrf.token}");
				},
				success : function(res) {
					alert("삭제 완료");
					location.reload();
				}
			});
		}
	});
});
let actionForm = $('#actionForm');

$('.paginate_button a').on('click', function(e) {
	e.preventDefault();
	//걸어둔 링크로 이동하는 것을 일단 막음 
	actionForm.find('input[name="pageNum"]').val($(this).attr('href'));
	actionForm.submit();
});

let searchForm = $('#searchForm');
$('#searchForm button').on('click', function(e) {
	if (!searchForm.find('option:selected').val()) {
		alert('검색종류를 선택하세요');
		return false;
	}
	if (!searchForm.find('input[name="keyword"]').val()) {
		alert('키워드를 입력하세요');
		return false;
	}
	e.preventDefault();
	searchForm.find('input[name="pageNum"]').val('1');
	searchForm.submit();
});
</script>
</html>