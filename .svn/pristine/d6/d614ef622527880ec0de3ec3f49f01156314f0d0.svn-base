package kr.or.ddit.controller.student;


import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import kr.or.ddit.service.student.StudentService;
import kr.or.ddit.util.EtcUtil;
import kr.or.ddit.vo.OrganizationChartVO;
import kr.or.ddit.vo.StudentVO;
import kr.or.ddit.vo.UserVO;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Controller
@RequestMapping("/student")
@RequiredArgsConstructor
@Slf4j
public class StudentController {
	
	private final EtcUtil etcUtil;
	
	@Autowired
	StudentService studentService;
	
	@GetMapping("/mypage")
	public String myPage(Model model) {
		
		UserVO userVO = etcUtil.getUserVO();
		
		ObjectMapper objectMapper = new ObjectMapper();
		
		String jsonUserVO = "";
		try {
			jsonUserVO = objectMapper.writeValueAsString(userVO);
		} catch (JsonProcessingException e) {
			log.error(e.getMessage());
		}
		
		log.info("jsonUSerVO ==> {}", jsonUserVO);
		
		model.addAttribute("jsonUserVO", jsonUserVO);
		
		return "stu_home";
	}
	// renderTree()의 ajax의 url
		@GetMapping("/nodelist")
		@ResponseBody
		public List<OrganizationChartVO> list() {
			List<OrganizationChartVO> chartList = this.studentService.chartList();
			
			log.info("chartList => {}", chartList);
			return chartList;
		}
		
		@GetMapping("/{nodeName}")
		public String create(@PathVariable String nodeName, Model model) {
			model.addAttribute("nodeName", nodeName);
			return "trees";
		}
}
