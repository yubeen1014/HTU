<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<script src="/resources/js/jquery.min.js"></script>
<sec:authentication property="principal.userVO" var="userVO"/>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/resources/test/fonts/icomoon/style.css">

    <link rel="stylesheet" href="/resources/test/css/owl.carousel.min.css">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/resources/test/css/bootstrap.min.css">
    
    <!-- Style -->
    <link rel="stylesheet" href="/resources/test/css/style.css">

</head>
<body>
  

  <div class="content" style="border: 2px solid blue; overflow-y: scroll; height: 100%">
    <div class="containerMail" style="border: 2px solid red;">

        <table class="table custom-table" style="border: 2px solid pink;">
          <thead>
            <tr>
              <th scope="col">
                <label class="control control--checkbox">
                  <input type="checkbox" class="js-check-all" name="mailCheck"/>
                  <div class="control__indicator"></div>
                </label>
              </th>
              <th onclick="read()">읽음</th>
            </tr>
          </thead>
          <tbody>
          	<c:forEach var="univMailVO" items="${data}">
	            <tr>
	              <th scope="row">
	                <label class="control control--checkbox">
	                  <input type="checkbox" name="mailCheck"  data-uml-cd="${univMailVO.umlCd}"/>
	                  <div class="control__indicator"></div>
	                </label>
	              </th>
	              <td>
	              <c:if test="${univMailVO.umlYn eq 0}">
	              	<img alt="" class="mailRead" src="/resources/images/mail2.png" style="width: 30px; height: 30px;">
	              </c:if>
	              <c:if test="${univMailVO.umlYn eq 1}">
	              	<img alt="" class="mailRead" src="/resources/images/readmail.png" style="width: 30px; height: 30px;">
	              </c:if>
	              </td>
	              <td>
	                ${univMailVO.userVO.userNm}
	              </td>
	              <td>
	              	<a class="mailTitle" href="/mail/receiveDetail?umlCd=${univMailVO.umlCd}" style="color: #333333">${univMailVO.umlTitle}</a>
	              </td>
	              <td><fmt:formatDate pattern="MM월 dd일 HH:mm" value="${univMailVO.umlReg}"/></td>
   	              <td><img src="/resources/images/x.png" style="width: 10px; height: 10px;" class="deleteMail" data-uml-cd="${univMailVO.umlCd}"></td>
	            </tr>
            </c:forEach>
          </tbody>
        </table>

    </div>

  </div>
    
    <script src="/resources/test/js/jquery-3.3.1.min.js"></script>
    <script src="/resources/test/js/popper.min.js"></script>
    <script src="/resources/test/js/bootstrap.min.js"></script>
    <script src="/resources/test/js/main.js"></script>
</body>
<script type="text/javascript">
$(function(){
	$(".deleteMail").on("click", function(){
		if(confirm("삭제하시겠습니까?")){
			let umlCd = $(this).data("umlCd");
			console.log("umlCd : " + umlCd);
			
			$.ajax({
				url:"/mail/deleteReceiveMail?umlCd="+umlCd,
				data:umlCd,
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					alert("삭제 완료");
					location.reload();
				}
			});
		}
	});
	
// 	$("#read").on("click", function(){
// 		let umlCd = $(".mailCheck").data("umlCd");
// 		console.log("umlCd : " + umlCd);
		
// 		let readArr = [];
		
// 		$("input[name=mailCheck]:checked").each(function() {
// 			var chkRead = $(".mailCheck").val();
// 			readArr.push(chkRead);
// 		});

// 		console.log("readArr : " + readArr);
		
// 	});
	
// 	$(".mailCheck").on("click", function(){
// 		let umlCd = $(this).data("umlCd");
// 		console.log("umlCd : " + umlCd);
// 	});

	function read(){
		let readArr = [];
		
		$('input:checkbox[name=mailCheck]').each(function (index) { 
			if($(this).is(":checked")==true){ 
				readArr.push($(this).val());
			}
		});
		$.ajax({
			url:"/mail/readMail",
			data:{"readArr":readArr},
			type:"post",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(res){
				console.log("읽음!");
				location.reload();
			}
		});
	}
});
</script>
</html>