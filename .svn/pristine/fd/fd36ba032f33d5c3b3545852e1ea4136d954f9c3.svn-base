<%@page import="kr.or.ddit.security.CustomUser"%>
<%@page import="org.springframework.web.socket.WebSocketSession"%>
<%@page import="kr.or.ddit.vo.UserVO"%>
<%@page import="org.springframework.security.core.context.SecurityContextHolder"%>
<%@page import="org.springframework.security.core.Authentication"%>
<%@page import="com.fasterxml.jackson.databind.ObjectMapper"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles" %>
<link rel="stylesheet" href="/resources/css/resMap.css">
<script src="/resources/js/jquery.min.js"></script>
<%
	ObjectMapper objectMapper = new ObjectMapper();
	CustomUser customUser = (CustomUser)SecurityContextHolder.getContext().getAuthentication().getPrincipal();
	String strUserVO = objectMapper.writeValueAsString(customUser.getUserVO());
	session.setAttribute("strUserVO", strUserVO);
%>



<input type="text" id="userVO" value='${strUserVO}' style="display: none;">
<div class="container">
  <h1 class="text-lg-center mb-5 mt-3" style="font-size: 30px;">시설 예약 현황</h1>
  <div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-3">
      <select class="form-select form-select-sm" id="building">
        <option value="">예약 건물 선택</option>
        <c:forEach items="${buldCommonList}" var="vo">
          <option value="${vo.comdCd}">${vo.comdNm}</option>
        </c:forEach>
      </select>
    </div>
    <div class="col-md-3" style="margin-left: 5px;">
      <select class="form-select form-select-sm" id="floor">
        <option value="">층수 선택</option>
      </select>
    </div>
    <div class="col-md-3"></div>
  </div>
  <div class="row map">
    <div class="floor mt-5" style="display: none;">
      <a href="#none" class="ho"><span>101</span></a>
      <a href="#none" class="ho"><span>102</span></a>
      <a href="#none" class="ho"><span>103</span></a>
      <span class="ho sisul"></span>
      <span class="ho sisul"></span>
      <a href="#none" class="ho"><span>104</span></a>
      <a href="#none" class="ho"><span>105</span></a>
      <a href="#none" class="ho"><span>106</span></a>
      <a href="#none" class="ho"><span>107</span></a>
      <a href="#none" class="ho"><span>108</span></a>
      <a href="#none" class="ho"><span>109</span></a>
      <a href="#none" class="ho"><span>110</span></a>
      <span class="ho sisul"></span>
      <span class="ho sisul"></span>
      <a href="#none" class="ho"><span>111</span></a>
      <a href="#none" class="ho"><span>112</span></a>
      <a href="#none" class="ho"><span>113</span></a>
      <a href="#none" class="ho"><span>114</span></a>
    </div>
  </div>
</div>


<!-- Modal1 -->
<div class="modal fade" id="roomResListModal" tabindex="-1" aria-labelledby="roomResListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="roomResListModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="calendar"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal2 -->
<div class="modal fade" id="roomResListModal2" aria-hidden="true" aria-labelledby="roomResListModalLabel2" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="roomResListModalLabel2">Modal 2</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="resBody">
        
        <table class="table table-borderless">
          <tr>
            <th>예약자 : </th>
            <td>예약자이름</td>
          </tr>
          <tr>
            <th>시작시간 : </th>
            <td>예약시작시간</td>
          </tr>
          <tr>
            <th>종료시간 : </th>
            <td>예약종료시간</td>
          </tr>
          <tr>
            <th>사유 : </th>
            <td>예약사유</td>
          </tr>
        </table>
        
      </div>
      <div class="modal-footer">
        <!-- <button class="btn btn-primary" data-bs-target="#roomResListModal" data-bs-toggle="modal">Back to first</button> -->
        <button class="btn btn-primary" onclick="showModalAndRenderCalendar()" data-bs-toggle="modal">Back to first</button>
      </div>
    </div>
  </div>
</div>

<!-- <button class="btn btn-primary" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Open first modal</button> -->


<script>
  let calendar;
  
  $("#building").on("change", function(event) {
    const building = $(event.target).val();
    const floorSet = new Set();
    $.ajax({
      url: "/reservation/getRoomListByComdCd?comdCd=" + building,
      type: "get",
      success: res => {
        res.forEach(room => {
          floorSet.add(room.roomCd.substr(6,1))
        })
        console.log(floorSet);
        let txt = '';
        floorSet.forEach((key, value) => {
          txt += `<option value="\${value}">\${value}층</option>`
        })
        $("#floor").html('');
        $("#floor").append('<option value="">층수 선택</option>');
        $("#floor").append(txt);
        
        $("#floor").on("change", function(event) {
          
          const floor = $(event.target).val();
          roomList = [];
          res.forEach(room => {
            if (room.roomCd.substr(6,1) == floor) {
              roomList.push(room);
            }
          });
          $(".floor").removeAttr("style");
          let txt = "";
          roomList.forEach((room, i) => {
            let roomNo = room.roomCd.substr(6);
            if (i == 3 || i == 10) {
              txt += `<span class="ho sisul stairs"><img src="/resources/images/stairs.png" alt="stair" style="display:block; width:60px;"></span><span class="ho sisul rest_room"><img src="/resources/images/toilet.png" alt="toilet" style="display:block; width:60px;"></span>`
            }
            txt += `<a href="#none" onclick="getResInfo('\${room.roomCd}')" class="ho">\${roomNo}호</a>`
          });
          $(".floor").html(txt);
        })
      }
    })
  })
  
  getResInfo = function(roomCd) {
    
    $.ajax({
      url: "/reservation/getResListByRoomCd?roomCd="+roomCd,
      dataType: "json",
      type: "get",
      async: false,
      success: res => {
        console.log("res =>", res);
        const resList = [];
        res.forEach(item => {
          let stdt = getTime(item.resStdt);
          let eddt = getTime(item.resEddt);
          stdt = stdt.substr(0, stdt.lastIndexOf('.'));
          eddt = eddt.substr(0, eddt.lastIndexOf('.'));
          console.log(stdt, eddt);
          resList.push({
            id: item.resCd,
            // title: item.roomVO.roomPur + " 예약",
            start: stdt,
            end: eddt,
            color: 'gray',
          })
        });
        console.log(resList);
        const roomNo = roomCd.substr(6);
        $("#roomResListModalLabel").text(`\${res[0].commonDetailVO.comdNm}   \${roomNo}호 예약현황`);
        let calendarEl = document.querySelector('#calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          locale : "ko",
          // 시작 Toolbar
          initialView : "timeGridWeek",
          // 선택가능여부
          selectable: true,
          // Toolbar
          headerToolbar : {
            left : "prev,next",
            center : "title",
            right : "timeGridWeek,timeGridDay,listMonth",
          },
          contentHeight: 335,
          // 일정을 배경으로만 체크
          eventDisplay: "background",
          // 수정가능여부
          editable: true,
          // 일정 목록
          events: resList,
          // 캘린더 랜더링 시작시간
          slotMinTime: "09:00:00",
          // 캘린더 랜더링 종료시간
          slotMaxTime: "22:00:00",
          // 시간 간격 설정
          slotDuration: "01:00:00",
          // allDaySlot X
          allDaySlot: false,
          // 선택했을 경우 선택가능 여부 return
          selectAllow: function(selectInfo) {
            let today = new Date();
            today.setHours(0,0,0,0);
            if (selectInfo.start < today) return false;
            const eventList = calendar.getEvents().some(function(event) {
              return (
                (event.start < selectInfo.end && event.end > selectInfo.start) ||
                (event.start >= selectInfo.start && event.end <= selectInfo.end)
              );
            });
            return !eventList;
          },
          // 날짜를 클릭했을 시 이벤트
          // dateClick: function(info) {
          //   console.log(info);
          // },
          // 선택했을 시 이벤트
          select: function(info) {
            console.log(info);
            $("#roomResListModal").modal("hide");
            
            let userVO = JSON.parse($("#userVO").val());
            console.log(userVO);
            
            let txt = `
              <form class="row g-3">
                <div class="col-md-4">
                  <label for="userCd" class="form-label">학번</label>
                  <input type="text" class="form-control" id="userCd" name="userCd" value="\${userVO.userCd}" readonly>
                </div>
                <div class="col-md-4">
                  <label for="depNm" class="form-label">학과</label>
                  <input type="text" class="form-control" id="depNm" value="\${userVO.studentVO.departmentVO.depNm}" readonly>
                </div>
                <div class="col-md-4">
                  <label for="userNm" class="form-label">이름</label>
                  <input type="text" class="form-control" id="userNm" value="\${userVO.userNm}" readonly>
                </div>
                <div class="col-md-6">
                  <label for="buldNm" class="form-label">건물</label>
                  <input type="text" class="form-control" id="buldNm" value="\${res[0].commonDetailVO.comdNm}">
                </div>
                <div class="col-md-6">
                  <label for="roomNo" class="form-label">호실</label>
                  <input type="text" class="form-control" id="roomNo" value="\${res[0].roomVO.roomCd.substr(6)}">
                </div>
                <div class="col-md-4">
                  <label for="inputState" class="form-label">State</label>
                  <select id="inputState" class="form-select">
                    <option selected>Choose...</option>
                    <option>...</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="inputZip" class="form-label">Zip</label>
                  <input type="text" class="form-control" id="inputZip">
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="gridCheck">
                    <label class="form-check-label" for="gridCheck">
                      Check me out
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary">Sign in</button>
                </div>
              </form>
            `;
            
            $("#roomResListModalLabel2").text("예약 신청")
            $("#resBody").html(txt);
            
            $("#roomResListModal2").modal("show");
          }
          // eventClick: function(info) {
          //   console.log(info);
          //   $("#roomResListModal").modal("hide");
          //   $("#roomResListModal2").modal("show");
          // }
        })
        showModalAndRenderCalendar();
      }
    })
    
  }
  
  function getTime(date) {
    let formDate = new Date(date);
    formDate.setHours(formDate.getHours() + 9);
    return formDate.toISOString();
  }
  
  function showModalAndRenderCalendar() {
    $("#roomResListModal").modal("show");
    setTimeout(() => {
      calendar.render();
    }, 180);
  }
  
  $(function() {
    
    
  })
</script>



