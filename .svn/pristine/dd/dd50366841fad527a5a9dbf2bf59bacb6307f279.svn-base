<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<script src="/resources/js/jquery.min.js"></script>
<style>
#rtnModal {
  position:absolute; 
  width:100%; 
  height:100%; 
  background: rgba(0,0,0,0.4); 
  top:0; 
  left:0; 
  display:none;
}
.rtnModal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  width: 40%;
  height: 60%;
}
#rtnBtn, #closeBtn {
  float: right;
}
.rtnReason {
  padding: 10px;
}
#rtnApp {
  width: 100%;
  height: 80%;
  font-size: 15px;
  border: 0;
  border-radius: 15px;
  outline: none;
  padding: 15px;
  background-color: rgb(233, 233, 233);
  resize: none;
}
</style>
<sec:authentication property="principal.userVO" var="userVO"/>
<input id="crCd" value="${crewVO.crCd}" hidden />
<%-- ${crewVO}<br> --%>
${crewPersonnelList}<br>
<%-- ${approvalVOList} --%>
<div id="rtnModal">
	<div class="rtnModal-content">
		<p class="rtnReason">반려 사유</p>
		<textarea id="rtnApp" maxlength=333 required="required"></textarea>
		<div>
			<button type="button" class="btn-two red mini" id="rtnBtn">확인</button>
			<button type="button" class="btn-two gray mini" id="closeBtn">닫기</button>
		</div>
	</div>
</div>
<div>
	<table>
		<tr>
			<td>동아리명</td>
			<td>${crewVO.crNm}</td>
		</tr>
		<tr>
			<td>동아리장</td>
			<td>${crewVO.ldrNm}</td>
		</tr>
		<tr>
			<td>동아리실 위치</td>
			<td>${crewVO.roomCd}</td>
		</tr>
		<tr>
			<td>첨부파일</td>
			<td>
				<c:forEach var="fileDetail" items="${crewVO.filesDetailVOList}">
	        		<a href="/resources/upload/${fileDetail.fileSvnm}" download="${fileDetail.fileOrnm}">${fileDetail.fileOrnm}</a><br>
	    		</c:forEach>
	    	</td>
		</tr>
		<c:if test="${crewVO.crLeader eq userVO.userCd}">
			<tr>
				<td><a href="/student/crew/crewUpdate?crCd=${crewVO.crCd}">동아리 수정</a></td>
			</tr>
			<tr>
				<td>동아리 가입 신청</td>
			</tr>
			<c:forEach var="approvalVO" items="${approvalVOList}">
			    <tr>
			        <td>${approvalVO.stuNm}</td>
			        <td>
			            <button type="button" data-app-yn="1" class="btnApp btn-two red mini" data-stu-cd="${approvalVO.stuCd}">승인</button>
			        </td>
			        <td>
			            <button type="button" data-app-yn="2" class="btnRtn btn-two blue mini" data-stu-cd="${approvalVO.stuCd}">반려</button>
			        </td>
			    </tr>
			</c:forEach>
		</c:if>
	</table>
	<div>
		<c:choose>
		    <c:when test="${crewPersonnelList ne null and not empty crewPersonnelList}">
		        <c:forEach var="personnel" items="${crewPersonnelList}">
		            <c:if test="${personnel.stuCd eq userVO.userCd}">
		                <button type="button" id="btnQuit" class="btn-two red mini">탈퇴</button>
		            </c:if>
		        </c:forEach>
		    </c:when>
		    <c:otherwise>
		        <c:choose>
		            <c:when test="${crewVO.appYn eq 0}">
		                <button type="button" class="btn-two red mini" disabled>가입</button>
		            </c:when>
		            <c:otherwise>
		                <button type="button" id="btnApply" data-stu-cd="${crewVO.stuCd}" class="btn-two red mini">가입</button>
		            </c:otherwise>
		        </c:choose>
		    </c:otherwise>
		</c:choose>
	</div>
</div>

<script>
$(function(){
	
	//승인 버튼 클릭 시
	$(".btnApp").on("click", function(){
		let appYn = $(this).data("appYn");
		let stuCd = $(this).data("stuCd");
        let crCd = "${crewVO.crCd}";
        
		console.log("appYn : " + appYn);
		console.log("stuCd : " + stuCd);
		console.log("crCd: " + crCd);
		
		$.ajax({
			url:"/student/crew/crewJoinApp",
			data:{
				appYn:appYn,
				stuCd:stuCd,
				crCd: crCd
			},
			type:"post",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(res){
				alert("성공");
			}
		});
	});
	
	//반려 버튼 클릭 시
	$(".btnRtn").on("click", function(){
		let stuCd = $(this).data("stuCd");
		
		console.log("stuCd: " + stuCd);
        
        $("#rtnModal").fadeIn();

        $("#closeBtn").on("click", function(){
        	$("#rtnModal").fadeOut();
        });
        
        $("#rtnBtn").on("click", function(){

			let crCd = "${crewVO.crCd}";
	        let rtnApp = $("#rtnApp").val();
	
	        console.log("stuCd: " + stuCd);
	        console.log("crCd: " + crCd);
	        console.log("rtnApp: " + rtnApp);
	        
            $("#rtnModal").modal("hide");

//             $.ajax({
//                 url: "/student/crew/crewReturn",
//                 data: {
//                     appYn: 2, 
//                     stuCd: stuCd,
//                     crCd: crCd,
//                     rtnApp: rtnApp
//                 },
//                 type: "post",
//                 beforeSend: function(xhr) {
//                     xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
//                 },
//                 success: function(res) {
//                     alert("Rejection Success");
//                 },
//                 error: function(err) {
//                     console.error("Error: " + err.responseText);
//                 }
//             });
        });
    });
	
	$("#btnApply").on("click", function(){
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		let crLeader = "${crewVO.crLeader}";
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		console.log("crLeader : " + crLeader);
// 		console.log("crewVO : " + crewVO);
		
		if(confirm("가입하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewJoin",
				data:{
					stuCd: stuCd,
					crCd: crCd,
					crLeader: crLeader
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					console.log("성공!!");
					location.href = "/student/crew/myCrew";
				}
			});
		}
	});
	
	$("#btnQuit").on("click", function(){
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		
		if(confirm("탈퇴하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewQuit",
				data:{
					stuCd:stuCd,
					crCd:crCd
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					alert("탈퇴 완료");
					location.href = "/student/crew/myCrew";
				}
			});
		}
	});
});
</script>