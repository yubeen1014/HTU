let alarmList = [];
let socket = null;

$(function() {
  connectWS();
});

// 소켓
connectWS = function() {
  let ws = new SockJS("http://localhost/echo");
  socket = ws;
  
  ws.onopen = function(userCd) {
    console.log("연결 완료");
    sendMessageToServer("로그인사용자");
  }
  
  ws.onmessage = function(event) {
    
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    
    $.ajax({
      url: "/getCommonDetail?comCd=ALAM",
      type: "get",
      beforeSend:function(xhr){
				xhr.setRequestHeader(header,token);
			},
      success: (res) => {
        console.log(res);
        alarmList = JSON.parse(event.data);
        console.log(alarmList);
        const comdSet = new Set();
        alarmList.forEach(alarm => {
          res.forEach(comdVO => {
            if (alarm.comdCd == comdVO.comdCd) comdSet.add(comdVO);
          })
        });
        console.log(comdSet);
        let txt = '';
        comdSet.forEach(item => {
          txt += `<li><a href="#none" onclick="alarmDetail('${item.comdCd}')" style="margin-left: 5px;">${item.comdNm}</a></li>`
        })
        $("#notificationDropdown ul:first").html(txt);
      }
    });
    
  };
  
  ws.onclose = function() {
    console.log("close");
  };
};

function sendMessageToServer(message) {
  socket.send(message);
};

function alarmDetail(comdCd) {
  console.log(alarmList);
  let txt = "";
  alarmList.forEach(alarm => {
    if (alarm.comdCd == comdCd) {
      txt += `<li><a href="${alarm.ntfUrl}">${alarm.commonDetailVO.comdDesc}</a></li>`
    }
  })
  $("#notificationDetail").html(txt);
  
}

